<!DOCTYPE html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="哲人镇, 哲学, 哲学家, 哲学论坛, java技术, 古希腊哲学家, 中国哲学">
    <meta name="Robots" content="none">
    <link rel="shortcut icon" href="/static/img/favicon.ico?v=2019092701"/>
    <title>文章修改</title>
    <link href="/static/css/public.css" rel="stylesheet">

    <script type="text/javascript" charset="utf-8" src="/static/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="/static/ueditor/ueditor.all.js"></script>
    <script src="/static/js/jquery-3.3.1.min.js"></script>
    <!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
    <!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
    <script type="text/javascript" charset="utf-8" src="/static/ueditor/lang/zh-cn/zh-cn.js"></script>

</head>
<body>

<div style="width:100%;background-color:#444444;margin-bottom:10px;">
    <a href="/" style="color:#ffffff;font-size:80%;"> ←返回首页</a>
</div>
<div style="margin-left:5px;margin-right:5px;">
    <h3 class="panel-title">修改文章</h3>

    标题：<input type="text" name="title" id="title" style="width:100%;" value="${title} "/><br>
    <input type="hidden" id="id" value="${id} " name="id"/><br>

    标签：<input type="text" name="tag" id="newTag" style="width:100%;"><br>
    <button onclick="addNewTag()">新增新标签</button>
    <div style="margin: 20px;">
        <span>点击删除标签</span>
        <div id="tagsInArticleListHtml" ></div>
        <span>点击添加标签</span>
        <div id="tagsNotInArticleListHtml" ></div>
    </div>

    <script id="uEditor" type="text/plain"></script>

    <button type="submit" onclick="updateArtile()">提&nbsp;&nbsp;&nbsp;&nbsp;交</button>
</div>

<textarea name="content" id="content"  style="display:none">${content}</textarea>
<script >
    var content =$("#content").val();
    var uEditor = UE.getEditor('uEditor');
    uEditor.ready(function () {//监听编辑器实例化完成的事件
        uEditor.setContent(content);
    });
</script>

<script type="text/javascript" src="/static/js/jenel.js"></script>
<script>

    function updateArtile() {
        var id = $("#id").val();
        var title = $("#title").val();
        var content = UE.getEditor('uEditor').getContent();
        var tag = $("#tag").val();
        if (title == "") {
            $.MsgBox.Confirm("提示", "标题不能为空！", function () {
            });
            return false;
        }
        // if (tag == "") {
        //     $.MsgBox.Confirm("提示", "标签不能为空！", function () {
        //     });
        //     return false;
        // }
        if (content == "") {
            $.MsgBox.Confirm("提示", "内容不能为空！", function () {
            });
            return false;
        }
        var dataObj = {};
        dataObj.id = id;
        dataObj.title = title;
        dataObj.tag = tag;
        dataObj.content = content;
        showReflesh();//显示缓冲图标
        $.ajax({
            url: "/article/update2Db",
            type: "POST",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            data: JSON.stringify(dataObj),
            success: function (result) {
                removeReflesh();
                if (result.code == 10000) {
                    $.MsgBox.Confirm("提示", "发布成功！", function () {
                        window.location.href = '/article/detail/' + result.data;
                    });

                } else {
                    $.MsgBox.Confirm("提示", result.message, function () {
                    });
                }
            },
            error: function () {
                removeReflesh();
                $.MsgBox.Confirm("提示", "系统异常，稍后重试", function () {
                });
            }
        });

    }


    function deleteTag(e) {
        var tag = $(e).html();
        var id = $("#id").val();

        if ($.isBlank(id)) {
            return false;
        }

        if ($.isBlank(tag)) {
            return false;
        }

        var dataObj = {};
        dataObj.id = id;
        dataObj.tag = tag;
        showReflesh();
        $.ajax({
            url: "/tag/delete",
            type: "POST",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            data: JSON.stringify(dataObj),
            success: function (result) {
                removeReflesh();
                if (result.code == 10000) {
                    $.MsgBox.Confirm("提示", "删除成功！", function () {
                        tagForArticleUpdate();
                    });

                } else {
                    $.MsgBox.Confirm("提示", result.message, function () {
                    });
                }
            },
            error: function () {
                removeReflesh();
                $.MsgBox.Confirm("提示", "系统异常，稍后重试", function () {
                });
            }
        });


    }

    function addTag(e) {
        var tag = $(e).html();
        var id = $("#id").val();

        if ($.isBlank(id)) {
            return false;
        }

        if ($.isBlank(tag)) {
            return false;
        }

        var dataObj = {};
        dataObj.id = id;
        dataObj.tag = tag;
        showReflesh();
        $.ajax({
            url: "/tag/add",
            type: "POST",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            data: JSON.stringify(dataObj),
            success: function (result) {
                removeReflesh();
                if (result.code == 10000) {
                    $.MsgBox.Confirm("提示", "新增成功！", function () {
                        tagForArticleUpdate();
                    });

                } else {
                    $.MsgBox.Confirm("提示", result.message, function () {
                    });
                }
            },
            error: function () {
                removeReflesh();
                $.MsgBox.Confirm("提示", "系统异常，稍后重试", function () {
                });
            }
        });
    }

    function addNewTag() {
        var tag = $("#newTag").val();
        var id = $("#id").val();

        if ($.isBlank(id)) {
            return false;
        }

        if ($.isBlank(tag)) {
            return false;
        }

        var dataObj = {};
        dataObj.id = id;
        dataObj.tag = tag;
        showReflesh();
        $.ajax({
            url: "/tag/add",
            type: "POST",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            data: JSON.stringify(dataObj),
            success: function (result) {
                removeReflesh();
                if (result.code == 10000) {
                    $.MsgBox.Confirm("提示", "新增成功！", function () {
                        tagForArticleUpdate();
                    });

                } else {
                    $.MsgBox.Confirm("提示", result.message, function () {
                    });
                }
            },
            error: function () {
                removeReflesh();
                $.MsgBox.Confirm("提示", "系统异常，稍后重试", function () {
                });
            }
        });
    }

    function tagForArticleUpdate() {
        try {
            var dataObj = {};
            var id = $("#id").val();

            if ($.isBlank(id)) {
                return false;
            }
            dataObj.id = id;
            $.ajax({
                url: "/tag/tagForArticleUpdate/" + id,
                type: "GET",
                dataType: "json",
                success: function (result) {
                    if (result.code == 10000) {
                        var tagsNotInArticleList = result.data.tagsNotInArticleList;
                        var tagsInArticleList = result.data.tagsInArticleList;
                        var tagsInArticleListHtml = '';
                        var tagsNotInArticleListHtml = '';
                        for (var i in tagsInArticleList) {
                            var tag = tagsInArticleList[i]
                            tagsInArticleListHtml += '<button class="button tagList" id="idIn' + tag + '" onclick="deleteTag(this);"style="height: 30px; font-size: 14px;">' +
                                tag + '</button>'
                        }

                        for (var i in tagsNotInArticleList) {
                            var tag = tagsNotInArticleList[i]
                            tagsNotInArticleListHtml += '<button class="button tagList" id="idNotIn' + tag + '" onclick="addTag(this);"style="height: 30px; font-size: 14px;">' +
                                tag + '</button>'
                        }

                        $("#tagsInArticleListHtml").html(tagsInArticleListHtml);
                        $("#tagsNotInArticleListHtml").html(tagsNotInArticleListHtml);

                    } else {
                        $.MsgBox.Confirm("提示", result.message, function () {
                        });
                    }
                },
                error: function () {
                    $.MsgBox.Confirm("提示", "系统繁忙，请重试", function () {
                    });
                }
            });
        } catch (err) {
        } finally {
        }
    }


    $(function () {
        tagForArticleUpdate();
    });

</script>
</body>
</html>