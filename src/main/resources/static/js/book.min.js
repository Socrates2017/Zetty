var isCreator=false;function getContent(a){$("#content").attr("src",a);changeFrameHeight();var b='<a href="'+a+'" target="_blank" ><span class="glyphicon glyphicon-share"></span></a>';$("#new-window-content").html(b)}function changeFrameHeight(){var a=document.getElementById("content");a.height=document.documentElement.clientHeight-30;$("#left-scroll").height(document.documentElement.clientHeight-30)}window.onresize=function(){changeFrameHeight()};function hideIndex(b){$("#index_"+b).html("");var a='<a href="javascript:void(0);" onclick="getIndex('+b+')"><span class="glyphicon glyphicon-chevron-right"></span></a>';$("#show-"+b).html(a)}function deleteIndex(){var a=$("#deleteIndexParentId").val();var g=$("#deleteIndexId").val();var d=$("#deleteIndexParentTitle").val().trim();var e=$("#bookId").val();if($.isBlank(e)){$.MsgBox.Confirm("提示","错误：bookId 为空！",function(){});return false}if($.isBlank(g)){$.MsgBox.Confirm("提示","错误：要删除的目录Id为空！",function(){});return false}if($.isBlank(d)){$.MsgBox.Confirm("提示","请输入要删除的章节目录名字！",function(){});return false}var c=$("#name-"+g);var f=c.text();if(f!=d){$.MsgBox.Confirm("提示","输入的章节目录名字不一致！",function(){});return false}var b={};b.id=g;b.bookId=e;showReflesh();$.ajax({url:"/bookIndex/delete",type:"POST",contentType:"application/json;charset=utf-8",dataType:"json",data:JSON.stringify(b),success:function(h){removeReflesh();if(h.code==10000){$.MsgBox.Confirm("提示","删除成功！",function(){getIndex(a)})}else{$.MsgBox.Confirm("提示",h.message+": "+h.data,function(){})}$("#deleteIndexModal").modal("hide")},error:function(){removeReflesh();$("#deleteIndexModal").modal("hide");$.MsgBox.Confirm("提示","系统异常，稍后重试",function(){})}})}function deleteBook(){var e=$("#bookId").val();if($.isBlank(e)){$.MsgBox.Confirm("提示","错误：bookId 为空！",function(){});return false}var c=$("#deleteBookName").val().trim();if($.isBlank(c)){$.MsgBox.Confirm("提示","请输入要删除的书名！",function(){});return false}var b=$("#bookName");var d=b.text();if(d!=d){$.MsgBox.Confirm("提示","输入书名不正确！",function(){});return false}var a={};a.bookId=e;showReflesh();$.ajax({url:"/book/delete",type:"POST",contentType:"application/json;charset=utf-8",dataType:"json",data:JSON.stringify(a),success:function(f){removeReflesh();if(f.code==10000){$.MsgBox.Confirm("提示","删除成功！",function(){location.href="/"})}else{$.MsgBox.Confirm("提示",f.message+": "+f.data,function(){})}$("#deleteIndexModal").modal("hide")},error:function(){removeReflesh();$("#deleteIndexModal").modal("hide");$.MsgBox.Confirm("提示","系统异常，稍后重试",function(){})}})}function addIndex(){var g=$("#parentId").val();var c=$("#url").val();var e=$("#childTitle").val();var f=$("#bookId").val();var d=$("#add-index-order").val();var b=$("input[name=add-isLeaf]:checked").val();if($.isBlank(d)){d=0}if($.isBlank(f)){$.MsgBox.Confirm("提示","错误：bookId 为空！",function(){});return false}if($.isBlank(g)){$.MsgBox.Confirm("提示","错误：parentId 为空！",function(){});return false}if($.isBlank(c)){$.MsgBox.Confirm("提示","错误：url 为空！",function(){});return false}if($.isBlank(e)){$.MsgBox.Confirm("提示","错误：name 为空！",function(){});return false}if($.isBlank(b)){$.MsgBox.Confirm("提示","请选择是否为目录章节！",function(){});return false}var a={};a.parentId=g;a.url=c;a.childTitle=e;a.bookId=f;a.indexOrder=d;a.isLeaf=b;showReflesh();$.ajax({url:"/bookIndex/add",type:"POST",contentType:"application/json;charset=utf-8",dataType:"json",data:JSON.stringify(a),success:function(h){removeReflesh();if(h.code==10000){$.MsgBox.Confirm("提示","新增成功！",function(){getIndex(g)})}else{$.MsgBox.Confirm("提示",h.message,function(){})}$("#addIndexModal").modal("hide")},error:function(){removeReflesh();$("#addIndexModal").modal("hide");$.MsgBox.Confirm("提示","系统异常，稍后重试",function(){})}})}function updateIndex(){var c=$("#update-pid").val();var h=$("#updateIndexId").val();var e=$("#updateIndexModalUrl").val();var d=$("#updateIndexModalTitle").val();var f=$("#update-index-order").val();var b=$("input[name=update-isLeaf]:checked").val();if($.isBlank(f)){f=0}var g=$("#bookId").val();if($.isBlank(g)){$.MsgBox.Confirm("提示","错误：bookId 为空！",function(){});return false}if($.isBlank(h)){$.MsgBox.Confirm("提示","错误：id 为空！",function(){});return false}if($.isBlank(e)){$.MsgBox.Confirm("提示","错误：url 为空！",function(){});return false}if($.isBlank(d)){$.MsgBox.Confirm("提示","错误：name 为空！",function(){});return false}if($.isBlank(b)){$.MsgBox.Confirm("提示","错误：isLeaf 为空！",function(){});return false}var a={};a.id=h;a.url=e;a.name=d;a.bookId=g;a.indexOrder=f;a.isLeaf=b;showReflesh();$.ajax({url:"/bookIndex/update",type:"POST",contentType:"application/json;charset=utf-8",dataType:"json",data:JSON.stringify(a),success:function(i){removeReflesh();if(i.code==10000){$.MsgBox.Confirm("提示","修改成功！",function(){});getIndex(c)}else{$.MsgBox.Confirm("提示",i.message,function(){})}$("#updateIndexModal").modal("hide")},error:function(){removeReflesh();$("#updateIndexModal").modal("hide");$.MsgBox.Confirm("提示","系统异常，稍后重试",function(){})}})}function updateIndexPid(b,e,c){b=parseInt(b);e=parseInt(e);var d=$("#bookId").val();if($.isBlank(d)){$.MsgBox.Confirm("提示","错误：bookId 为空！",function(){});return false}if(isNaN(b)){$.MsgBox.Confirm("提示","错误：pid 为空，请拖放到标题上！",function(){});return false}if(isNaN(e)){$.MsgBox.Confirm("提示","错误：id 为空，请按住标题左边的空白处开始拖动",function(){});return false}var a={};a.id=e;a.pid=b;a.bookId=d;showReflesh();$.ajax({url:"/bookIndex/updatePid",type:"POST",contentType:"application/json;charset=utf-8",dataType:"json",data:JSON.stringify(a),success:function(f){removeReflesh();if(f.code==10000){$.MsgBox.Confirm("提示","修改成功！",function(){});getIndex(b);getIndex(c)}else{$.MsgBox.Confirm("提示",f.message,function(){})}$("#updateIndexModal").modal("hide")},error:function(){removeReflesh();$("#updateIndexModal").modal("hide");$.MsgBox.Confirm("提示","系统异常，稍后重试",function(){})}})}function updateBook(){var b=$("#updateBookName").val();var d=$("#updateBookDescription").val();var c=$("#bookId").val();if($.isBlank(c)){$.MsgBox.Confirm("提示","错误：bookId 为空！",function(){});return false}if($.isBlank(b)){if($.isBlank(c)){$.MsgBox.Confirm("提示","错误：书名不能为空！",function(){});return false}}if($.isBlank(d)){if($.isBlank(c)){$.MsgBox.Confirm("提示","错误：摘要不能为空！",function(){});return false}}var a={};a.bookId=c;a.name=b;a.description=d;showReflesh();$.ajax({url:"/book/update",type:"POST",contentType:"application/json;charset=utf-8",dataType:"json",data:JSON.stringify(a),success:function(e){removeReflesh();if(e.code==10000){$.MsgBox.Confirm("提示","修改成功！",function(){});getBookInfo()}else{$.MsgBox.Confirm("提示",e.message,function(){})}$("#updateBookModal").modal("hide")},error:function(){removeReflesh();$("#updateBookModal").modal("hide");$.MsgBox.Confirm("提示","系统异常，稍后重试",function(){})}})}function showAddIndexModal(a){$("#parentId").val(a);$("#addIndexModal").modal("show")}function showUpdateIndexModal(c,f,e,d,a,b){$("#update-pid").val(c);$("#updateIndexId").val(f);$("#updateIndexModalTitle").val(e);$("#updateIndexModalUrl").val(d);$("#update-index-order").val(a);if(b==0){$("input[name='update-isLeaf'][value=0]").prop("checked",true)}else{$("input[name='update-isLeaf'][value=1]").prop("checked",true)}$("#updateIndexModal").modal("show")}function showDeleteIndexModal(b,a){$("#deleteIndexParentId").val(b);$("#deleteIndexId").val(a);$("#deleteIndexModal").modal("show")}function showDeleteBookModal(){$("#deleteBookModal").modal("show")}function showUpdateBookModal(){$("#updateBookName").val($("#bookName").text());$("#updateBookDescription").val($("#bookDescription").text());$("#updateBookModal").modal("show")}function drag(b){var c=b.target.id;var a=b.target.parentNode.id;b.dataTransfer.setData("Text",c+"#"+a)}function dragEnd(a){}function dragEnter(a){a.preventDefault();a.target.style.border="3px dotted red"}function allowDrop(a){a.preventDefault()}function dragLeave(a){a.preventDefault();a.target.style.border=""}function drop(d){d.preventDefault();d.target.style.border="";var a=d.target.parentNode.parentNode;var b=a.id;if(b.substr(0,3)=="li-"){b=b.substr(3)}else{if(b.substr(0,6)=="index_"){b=b.substr(6)}}var e=d.dataTransfer.getData("Text").split("#");var f=e[0].substr(3);var c=e[1].substr(3);updateIndexPid(b,f,c)}function indentRight(){var d=$("#left").attr("class").split(" ");var a=3;for(var e=0,g=d.length;e<g;e++){var h=d[e];if(h.substr(0,7)=="col-sm-"){a=parseInt(h.substr(7));break}}var m=12-a;var l="col-sm-"+a+" col-md-"+a+" col-lg-"+a;var k="col-sm-"+m+" col-md-"+m+" col-lg-"+m;var f=a+1;var i=12-f;var c="col-sm-"+f+" col-md-"+f+" col-lg-"+f;var b="col-sm-"+i+" col-md-"+i+" col-lg-"+i;$("#left").removeClass(l);$("#left").addClass(c);$("#right").removeClass(k);$("#right").addClass(b)}function indentLeft(){var d=$("#left").attr("class").split(" ");var a=3;for(var e=0,g=d.length;e<g;e++){var h=d[e];if(h.substr(0,7)=="col-sm-"){a=parseInt(h.substr(7));break}}var m=12-a;var l="col-sm-"+a+" col-md-"+a+" col-lg-"+a;var k="col-sm-"+m+" col-md-"+m+" col-lg-"+m;var f=a-1;var i=12-f;var c="col-sm-"+f+" col-md-"+f+" col-lg-"+f;var b="col-sm-"+i+" col-md-"+i+" col-lg-"+i;$("#left").removeClass(l);$("#left").addClass(c);$("#right").removeClass(k);$("#right").addClass(b)}function hideLeft(){var c=$("#left").attr("class").split(" ");var g=3;for(var b=0,a=c.length;b<a;b++){var d=c[b];if(d.substr(0,7)=="col-sm-"){g=parseInt(d.substr(7));break}}var f=12-g;var e="col-sm-"+f+" col-md-"+f+" col-lg-"+f;$("#left").hide();$("#right").removeClass(e);$("#right").addClass("col-sm-12 col-md-12 col-lg-12");$("#indentRight").hide()}function showLeft(){var c=$("#left").attr("class").split(" ");var e=3;for(var b=0,a=c.length;b<a;b++){var d=c[b];if(d.substr(0,7)=="col-sm-"){e=parseInt(d.substr(7));break}}var g=12-e;var f="col-sm-"+g+" col-md-"+g+" col-lg-"+g;$("#left").show();$("#right").removeClass("col-sm-12 col-md-12 col-lg-12");$("#right").addClass(f);$("#indentRight").show()}function hideOrShowLeft(){var a=$("#indentRight").is(":hidden");if(a){showLeft()}else{hideLeft()}}function getIndex(b){var a=$("#bookId").val();if($.isBlank(a)){$.MsgBox.Confirm("提示","错误：bookId 为空！",function(){});return}$.ajax({url:"/bookIndex/children?book="+a+"&parent="+b,type:"GET",datatype:"json",async:true,success:function(c){var g=c.code;if(g==10000){var h=c.data;var f='<ul class="" id="ul-'+b+'" >';for(var e in h){var k=h[e];var d=k.isLeaf;f+='<li id="li-'+k.id+'" class=""  style="margin-top:20px;" draggable="true" ondragstart="drag(event)" ';if(d==0){f+='ondrop="drop(event)" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)" ondragover="allowDrop(event)">';f+='<div style="display: inline" id="show-'+k.id+'"><a href="javascript:void(0);" onclick="getIndex('+k.id+')"><span class="glyphicon glyphicon-chevron-right"></span></a></div>'}else{f+=">"}f+='&emsp;<a href="javascript:void(0);" onclick="getContent(\''+k.url+'\')"><span id="name-'+k.id+'">'+k.name+"</span></a>";if(isCreator){f+='&emsp;&emsp;<div style="display: inline" id="opear-'+k.id+'"><a href="javascript:void(0);" onclick="showUpdateIndexModal('+b+","+k.id+",'"+k.name+"','"+k.url+"',"+k.indexOrder+","+d+')"><span class="glyphicon glyphicon-pencil"></span></a>';if(d==0){f+='<a href="javascript:void(0);" onclick="showAddIndexModal('+k.id+')"><span class="glyphicon glyphicon-plus-sign"></span></a>'}f+='<a href="javascript:void(0);" onclick="showDeleteIndexModal('+b+","+k.id+')"><span class="glyphicon glyphicon-minus-sign"></span></a></div></li> '}f+='<div id="index_'+k.id+'" style="padding-left:20px;" ></div>'}f+="</ul>";$("#index_"+b).html(f);var j='<a href="javascript:void(0);" onclick="hideIndex('+b+')"><span class="glyphicon glyphicon-chevron-down"></span></a>';$("#show-"+b).html(j)}else{console.log(c.message)}}})}function checkUser(b){var a=$("#bookId").val();if($.isBlank(a)){$.MsgBox.Confirm("提示","错误：bookId 为空！",function(){});return}$.ajax({url:"/book/checkUser?bookId="+a,type:"GET",datatype:"json",async:true,success:function(c){var d=c.code;if(d==10000){$(".user-show").show();isCreator=true}else{$(".user-show").hide()}b(0)},error:function(){b(0)}})}function getBookInfo(){var a=$("#bookId").val();if($.isBlank(a)){$.MsgBox.Confirm("提示","错误：bookId 为空！",function(){});return}$.ajax({url:"/book/info/"+a,type:"GET",datatype:"json",async:true,success:function(b){var c=b.code;if(c==10000){var d=b.data;$("#bookName").html(d.name);$("#bookCreator").html(d.creator);$("#bookDescription").html(d.description);document.title=d.name}else{$.MsgBox.Confirm("提示",b.message,function(){})}},error:function(){$.MsgBox.Confirm("提示","系统异常，请稍后重试",function(){})}})}$(function(){$("#left-scroll").height(document.documentElement.clientHeight-30);var a=window.location.pathname;var b=a.substr(6);$("#bookId").val(b);getBookInfo();checkUser(getIndex)});